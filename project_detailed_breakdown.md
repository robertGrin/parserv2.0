# Подробный разбор проекта "AI Telegram Parser & Analyst"

Этот файл содержит максимально подробный разбор всего проекта по винтикам. Я объясню каждую часть просто и понятно, как будто рассказываю другу. Проект — это Telegram-бот, который парсит каналы, сохраняет сообщения в базу данных, строит графики и использует ИИ для анализа.

## 1. Общая структура проекта

Проект состоит из следующих файлов и папок:

- **README.md**: Описание проекта, как его установить и использовать.
- **requirements.txt**: Список библиотек Python, которые нужны для работы.
- **docker-compose.yml**: Настройки для запуска в Docker-контейнере.
- **Dockerfile**: Инструкции для создания Docker-образа.
- **install.bat**: Скрипт для Windows, чтобы управлять проектом через меню.
- **.gitignore**: Список файлов, которые не нужно загружать в Git (например, сессии и логи).
- **src/**: Папка с основным кодом Python.
  - **manager.py**: Главный файл бота, где вся логика.
  - **add_account.py**: Скрипт для авторизации в Telegram.
  - **database.py**: Настройки базы данных (но в manager.py база тоже описана).
  - **__init__.py**: Пустой файл, чтобы папка была модулем Python.
- **sessions/**: Папка для файлов сессий Telegram (создается автоматически).
- **add_account.py**: Копия скрипта add_account.py в корне (возможно, для удобства).

Проект использует Docker для запуска, чтобы все работало одинаково на разных компьютерах.

## 2. Зависимости и конфигурация

### requirements.txt
Это список библиотек Python. Каждая строка — это библиотека с версией:

- **aiogram==3.10.0**: Для создания Telegram-бота. Позволяет обрабатывать команды и сообщения.
- **telethon==1.36.0**: Для работы с Telegram API. Используется для парсинга каналов и авторизации.
- **sqlalchemy==2.0.30**: Для работы с базой данных. Позволяет сохранять и читать данные из SQLite или PostgreSQL.
- **pandas==2.2.2**: Для работы с данными в виде таблиц. Используется для анализа сообщений.
- **openpyxl==3.1.5**: Для экспорта данных в Excel-файлы.
- **python-dotenv==1.0.1**: Для чтения переменных окружения из файла .env.
- **psycopg2-binary**: Для подключения к PostgreSQL (если не SQLite).
- **matplotlib==3.8.4**: Для рисования графиков.
- **google-generativeai==0.5.2**: Для работы с ИИ Google Gemini.

Эти библиотеки устанавливаются командой `pip install -r requirements.txt`.

### .env файл
Это файл с секретными настройками (не загружается в Git). В нем:

- **API_ID**: ID вашего приложения Telegram (получить на my.telegram.org).
- **API_HASH**: Хэш приложения Telegram.
- **BOT_TOKEN**: Токен бота от @BotFather.
- **ADMIN_ID**: Ваш ID в Telegram (только вы можете управлять ботом).
- **DATABASE_URL**: Адрес базы данных (по умолчанию sqlite:///parser.db).
- **GEMINI_API_KEY**: Ключ для ИИ Google Gemini.

Без этого файла бот не запустится.

## 3. Разбор кода по файлам

### src/manager.py (главный файл)
Это сердце проекта. Здесь бот, парсинг, база данных и ИИ.

#### Импорты
- **asyncio**: Для асинхронного кода (бот работает параллельно).
- **os, logging**: Для работы с файлами и логирования ошибок.
- **matplotlib**: Для графиков (использует 'Agg' бэкенд, чтобы рисовать без экрана).
- **pandas**: Для таблиц данных.
- **google.generativeai**: Для ИИ.
- **aiogram**: Бот-фреймворк.
- **telethon**: Для Telegram-клиента.
- **sqlalchemy**: База данных.
- **dotenv**: Чтение .env.

#### Настройки
- Загружает переменные из .env.
- Настраивает логирование (INFO уровень).
- Инициализирует ИИ, если есть ключ.
- Создает бота, диспетчер, базу данных.
- Определяет модель ParsedMessage: таблица с id, названием канала, текстом сообщения, датой.

#### Функции парсинга
- **fetch_history(client, channel_entity, limit=100)**: Скачивает последние сообщения из канала и сохраняет в базу. Возвращает количество загруженных сообщений.

#### Логика юзер-бота
- **start_user_bot()**: Создает клиент Telegram для вашего аккаунта. Ищет файл сессии в папке sessions. Если нет — ошибка. Запускает обработчик новых сообщений: когда приходит новое сообщение в канал, сохраняет его в базу.

#### Функции аналитики
- **generate_plot(df)**: Рисует график топ-каналов по количеству постов. Использует matplotlib, сохраняет в память (BytesIO).
- **get_ai_analysis(df)**: Отправляет данные в Google Gemini и получает текстовый анализ.

#### Команды бота
Все команды проверяют, что пользователь — админ (ADMIN_ID).

- **/start**: Показывает меню команд.
- **/list**: Показывает список каналов, в которых состоит ваш аккаунт.
- **/sync**: Синхронизирует историю всех каналов (скачивает последние 50 сообщений из каждого).
- **/join <ссылка>**: Вступает в канал по ссылке (публичной или приватной) и скачивает 100 сообщений.
- **/stats**: Строит график и получает ИИ-анализ данных из базы.
- **/export**: Экспортирует все данные в Excel-файл и отправляет его.

#### main()
- Запускает юзер-бота.
- Запускает polling бота (ждет команд).

### src/add_account.py
Скрипт для авторизации в Telegram.

- Создает клиент с вашими API_ID и API_HASH.
- Создает папку sessions, если нет.
- Запускает авторизацию: вводите номер телефона, код из SMS/app.
- Сохраняет сессию в sessions/my_account.session.
- После этого можно запускать основной бот.

### src/database.py
В manager.py база уже настроена, но этот файл, возможно, для дополнительных настроек. В коде он не используется напрямую.

### src/__init__.py
Пустой файл. Нужен, чтобы Python видел папку src как модуль.

### install.bat
Скрипт для Windows-меню.

- **1. Установить/Обновить**: docker-compose down -v (останавливает и удаляет контейнеры), docker-compose build --no-cache app (собирает образ заново).
- **2. Войти в аккаунт**: docker-compose run --rm app python src/add_account.py (запускает авторизацию в контейнере).
- **3. Запустить парсер**: docker-compose up -d (запускает в фоне).
- **4. Смотреть логи**: docker-compose logs -f app (показывает логи в реальном времени).
- **5. Остановить всё**: docker-compose down (останавливает).

### docker-compose.yml
Настройки Docker.

- **version: '3.8'**: Версия формата.
- **services.app**: Сервис приложения.
  - **build: .**: Собирает из Dockerfile.
  - **container_name**: Имя контейнера.
  - **restart: on-failure**: Перезапускает при ошибке.
  - **volumes**: Монтирует папки (код и sessions).
  - **env_file: .env**: Читает переменные.
  - **command**: Запускает python src/manager.py.

### Dockerfile
Инструкции для образа.

- **FROM python:3.10-slim**: Базовый образ Python.
- **WORKDIR /app**: Рабочая папка.
- **RUN apt-get update && apt-get install -y gcc libpq-dev**: Устанавливает компилятор для psycopg2.
- **COPY requirements.txt . RUN pip install --no-cache-dir -r requirements.txt**: Копирует и устанавливает зависимости.
- **RUN mkdir -p /app/sessions**: Создает папку для сессий.
- **COPY . .**: Копирует весь код.
- **ENV PYTHONPATH=/app**: Добавляет /app в путь Python.

### .gitignore
Игнорирует:
- __pycache__/ (кеш Python).
- venv/ (виртуальное окружение).
- .env (секреты).
- sessions/ (сессии Telegram).
- *.session, *.session-journal (файлы сессий).
- *.log (логи).

## 4. Процесс запуска и работы

1. **Установка**: Скачать проект, создать .env, запустить install.bat -> 1 (собрать).
2. **Авторизация**: install.bat -> 2 (ввести телефон и код).
3. **Запуск**: install.bat -> 3 (бот работает в фоне).
4. **Использование**: Отправить /start боту, использовать команды.
5. **Парсинг**: Бот автоматически сохраняет новые сообщения из каналов, куда вступил.
6. **Анализ**: /stats для графика и ИИ-отчета, /export для Excel.

## 5. Возможные команды и их функционал

- **В боте**:
  - /start: Меню.
  - /list: Список каналов.
  - /sync: Загрузить историю.
  - /join: Вступить и загрузить.
  - /stats: График + ИИ.
  - /export: Скачать Excel.

- **В install.bat**:
  - 1: Собрать контейнер.
  - 2: Авторизоваться.
  - 3: Запустить.
  - 4: Логи.
  - 5: Остановить.

- **В коде**: Функции как fetch_history, generate_plot — внутренние, вызываются командами.

Это полный разбор. Если что-то неясно, спрашивай!
